const glyphs = [
  { simbolo: "ìÇÄ", resposta: "Olho de H√≥rus", opcoes: ["Olho de H√≥rus", "Sol Nascente", "Pir√¢mide", "Ciclo da Vida"] },
  { simbolo: "ìáã", resposta: "Junco Florido (I)", opcoes: ["Junco Florido (I)", "Cajado", "Espada", "Fara√≥"] },
  { simbolo: "ìÇª", resposta: "Par de Pernas (Andar)", opcoes: ["Correr", "Par de Pernas (Andar)", "Pular", "Dan√ßar"] },
  { simbolo: "ìÜ£", resposta: "Besouro (Khepri)", opcoes: ["Cobra Real", "Gato Preto", "Besouro (Khepri)", "√Åguia"] },
  { simbolo: "ìäπ", resposta: "Deus", opcoes: ["Deus", "Sacerdote", "Templo", "Eternidade"] },
  { simbolo: "ìÅ®", resposta: "Crian√ßa", opcoes: ["Adulto", "Crian√ßa", "Velho", "Fam√≠lia"] },
  { simbolo: "ìãπ", resposta: "Ankh (Vida)", opcoes: ["Ankh (Vida)", "Morte", "Renascer", "Amor"] },
  { simbolo: "ìÑø", resposta: "Falc√£o (H√≥rus)", opcoes: ["√Åguia", "P√°ssaro", "Falc√£o (H√≥rus)", "Coruja"] },
  { simbolo: "ìèè", resposta: "P√£o", opcoes: ["√Ågua", "Vinho", "P√£o", "Fruta"] },
  { simbolo: "ìàñ", resposta: "√Ågua", opcoes: ["Fogo", "Terra", "Ar", "√Ågua"] }
];

let score = 0;
let indiceAtual = 0;
let tempo = 15;
let timer;
let glyphsEmbaralhados = [];

// Fun√ß√µes de √°udio
const audioAcerto = document.getElementById("acerto");
const audioErro = document.getElementById("erro");
const audioVitoria = document.getElementById("vitoria");
const audioDerrota = document.getElementById("derrota");

// Adi√ß√£o para m√∫sica ambiente
const backgroundMusic = document.getElementById("backgroundMusic");
const toggleMusicButton = document.getElementById("toggleMusic");
let isMusicPlaying = false;

// Adiciona um volume inicial mais baixo para a m√∫sica ambiente
backgroundMusic.volume = 0.4;

// Refer√™ncias para o personagem guia e bal√£o de fala
const guideCharacter = document.getElementById("guideCharacter");
const guideSpeechBubble = document.getElementById("guideSpeechBubble");

// --- Defini√ß√µes para Progress√£o Tem√°tica ---
const gameThemes = [
  {
    name: "Deserto",
    minScore: 0,
    bodyClass: "theme-desert",
    musicSrc: "musica_ambiente_deserto.mp3" // Confirme que este arquivo existe
  },
  {
    name: "Nilo",
    minScore: 5, // Ap√≥s 5 acertos, muda para o Nilo
    bodyClass: "theme-nile",
    musicSrc: "musica_ambiente_nilo.mp3" // Confirme que este arquivo existe
  },
  {
    name: "Tumba",
    minScore: 10, // Ap√≥s 10 acertos, muda para Tumba
    bodyClass: "theme-tomb",
    musicSrc: "musica_ambiente_tumba.mp3" // Confirme que este arquivo existe
  }
];
let currentThemeIndex = -1; // Inicializa com -1 para garantir que o primeiro tema seja aplicado corretamente

// --- Defini√ß√µes para Personagem Guia ---
const guideFeedback = {
  correct: {
    text: ["Magn√≠fico! Sua sabedoria √© digna dos fara√≥s!", "Correto! Sua mente √© afiada!", "Excelente trabalho!"],
    image: "escriba_feliz.png" // Confirme que este arquivo existe
  },
  incorrect: {
    text: ["Quase l√°! Continue tentando, a verdade est√° escondida.", "N√£o desista! O caminho da aprendizagem √© longo.", "Tente novamente, voc√™ consegue!"],
    image: "escriba_triste.png" // Confirme que este arquivo existe
  },
  timeout: {
    text: ["O tempo esgotou! A pressa √© inimiga da perfei√ß√£o.", "R√°pido como o vento, mas a sabedoria leva tempo."],
    image: "escriba_surpreso.png" // Confirme que este arquivo existe
  },
  welcome: { // Mensagem inicial no menu
    text: ["Sauda√ß√µes, viajante! Decifre os mist√©rios do Egito antigo.", "Bem-vindo(a) ao Jogo dos Hier√≥glifos!"],
    image: "escriba_neutro.png" // Confirme que este arquivo existe
  },
  start_game: { // Mensagem ao iniciar o jogo
    text: ["Que a jornada da sabedoria comece!", "Desafie sua mente agora!"],
    image: "escriba_neutro.png"
  },
  free_mode: { // Mensagem ao entrar no modo livre
    text: ["Sinta-se √† vontade para criar seus pr√≥prios hier√≥glifos!", "Liberdade para a escrita!"],
    image: "escriba_neutro.png"
  },
  goodbye: { // Mensagem ao sair ou fim de jogo
      text: ["At√© a pr√≥xima jornada!", "Que os deuses o(a) aben√ßoem!"],
      image: "escriba_neutro.png"
  }
};

// Fun√ß√£o para tocar/pausar a m√∫sica
function toggleMusic() {
  if (isMusicPlaying) {
    backgroundMusic.pause();
    isMusicPlaying = false;
    toggleMusicButton.textContent = "M√∫sica: OFF";
  } else {
    backgroundMusic.play().then(() => {
      isMusicPlaying = true;
      toggleMusicButton.textContent = "M√∫sica: ON";
    }).catch(error => {
      console.log("Erro ao tocar m√∫sica:", error);
      // Alguns navegadores bloqueiam autoplay sem intera√ß√£o do usu√°rio.
      // A m√∫sica pode n√£o iniciar aqui, mas iniciar√° ao clicar em "Iniciar Jogo".
    });
  }
}

// Adicionar listener ao bot√£o de m√∫sica
if (toggleMusicButton) {
  toggleMusicButton.addEventListener("click", toggleMusic);
}

// Fun√ß√£o para mostrar o feedback do guia
function showGuideFeedback(type) {
  const feedbackData = guideFeedback[type];
  if (!feedbackData) return;

  const randomIndex = Math.floor(Math.random() * feedbackData.text.length);
  guideSpeechBubble.textContent = feedbackData.text[randomIndex];
  guideCharacter.src = feedbackData.image;

  guideCharacter.classList.remove("hidden");
  guideSpeechBubble.classList.remove("hidden");

  // Esconde o bal√£o e o personagem ap√≥s 3 segundos
  setTimeout(() => {
    guideCharacter.classList.add("hidden");
    guideSpeechBubble.classList.add("hidden");
  }, 3000);
}

// Fun√ß√£o para atualizar o tema do jogo
function updateGameTheme() {
    let newThemeIndex = currentThemeIndex;
    for (let i = gameThemes.length - 1; i >= 0; i--) {
        if (score >= gameThemes[i].minScore) {
            newThemeIndex = i;
            break;
        }
    }

    if (newThemeIndex !== currentThemeIndex) {
        // Remove a classe do tema anterior, se houver uma ativa
        if (currentThemeIndex !== -1) {
            document.body.classList.remove(gameThemes[currentThemeIndex].bodyClass);
        }
        currentThemeIndex = newThemeIndex;
        // Adiciona a classe do novo tema
        document.body.classList.add(gameThemes[currentThemeIndex].bodyClass);

        // Mudar a m√∫sica ambiente se houver uma nova para o tema
        if (gameThemes[currentThemeIndex].musicSrc && backgroundMusic.src !== window.location.origin + '/' + gameThemes[currentThemeIndex].musicSrc) {
            // Use window.location.origin para garantir o caminho absoluto correto
            backgroundMusic.src = gameThemes[currentThemeIndex].musicSrc;
            if (isMusicPlaying) {
                backgroundMusic.play();
            }
        }
    }
}

function shuffle(array) {
  return array.sort(() => Math.random() - 0.5);
}

function iniciarJogo() {
  document.getElementById("menu").classList.add("hidden");
  document.getElementById("jogo").classList.remove("hidden");
  reiniciar(); // Reinicia o jogo e aplica o tema inicial
  showGuideFeedback('start_game'); // Mensagem do guia ao iniciar o jogo
  // Tenta tocar a m√∫sica se n√£o estiver tocando
  if (!isMusicPlaying) {
    backgroundMusic.play().then(() => {
      isMusicPlaying = true;
      toggleMusicButton.textContent = "M√∫sica: ON";
    }).catch(error => {
      console.log("M√∫sica ambiente n√£o p√¥de ser iniciada automaticamente na fun√ß√£o iniciarJogo. Erro:", error);
    });
  }
}

function mostrarModoLivre() {
  document.getElementById("menu").classList.add("hidden");
  document.getElementById("livre").classList.remove("hidden");
  showGuideFeedback('free_mode'); // Mensagem do guia no modo livre
}

function voltarAoMenu() {
  document.getElementById("jogo").classList.add("hidden");
  document.getElementById("fim").classList.add("hidden");
  document.getElementById("livre").classList.add("hidden");
  document.getElementById("menu").classList.remove("hidden");
  clearInterval(timer); // Para o timer se estiver ativo
  showGuideFeedback('goodbye'); // Mensagem do guia ao voltar ao menu
  // A m√∫sica ambiente continua tocando no menu.
  // Se quiser parar: backgroundMusic.pause(); isMusicPlaying = false; toggleMusicButton.textContent = "M√∫sica: OFF";
}

function carregarGlyph() {
  clearInterval(timer);
  tempo = 15;
  document.getElementById("time").textContent = tempo;
  timer = setInterval(contarTempo, 1000);

  const atual = glyphsEmbaralhados[indiceAtual];
  document.getElementById("glyph").textContent = atual.simbolo;

  const botoes = document.querySelectorAll(".options button");
  const opcoesEmbaralhadas = shuffle([...atual.opcoes]); // Copia e embaralha as op√ß√µes
  botoes.forEach((btn, i) => {
    btn.textContent = opcoesEmbaralhadas[i];
    btn.disabled = false;
    btn.classList.remove("correct", "incorrect"); // Limpa classes de feedback
  });

  document.getElementById("feedback").textContent = "";
}

function contarTempo() {
  tempo--;
  document.getElementById("time").textContent = tempo;
  if (tempo <= 0) {
    clearInterval(timer);
    mostrarFeedback(false, true); // Passa true para indicar que o tempo acabou
  }
}

function checkAnswer(botao) {
  clearInterval(timer);
  const atual = glyphsEmbaralhados[indiceAtual];
  const resposta = botao.textContent;
  const correta = resposta === atual.resposta;

  mostrarFeedback(correta, false, botao);
}

function mostrarFeedback(correto, tempoEsgotado = false, botaoClicado = null) {
  const atual = glyphsEmbaralhados[indiceAtual];
  const botoes = document.querySelectorAll(".options button");
  botoes.forEach(btn => btn.disabled = true);

  const feedback = document.getElementById("feedback");

  if (correto) {
    score++;
    audioAcerto.play();
    feedback.textContent = "‚úÖ Correto!";
    if (botaoClicado) {
      botaoClicado.classList.add("correct");
    }
    showGuideFeedback('correct'); // Acertou, mostra feedback do guia
  } else {
    audioErro.play();
    if (tempoEsgotado) {
      feedback.textContent = "‚è∞ Tempo esgotado! Era: " + atual.resposta;
      showGuideFeedback('timeout'); // Tempo esgotado, mostra feedback do guia
    } else {
      feedback.textContent = "‚ùå Errado! Era: " + atual.resposta;
      if (botaoClicado) {
        botaoClicado.classList.add("incorrect");
      }
      showGuideFeedback('incorrect'); // Errou, mostra feedback do guia
    }
    // Destacar a resposta correta se houver uma op√ß√£o correspondente
    botoes.forEach(btn => {
      if (btn.textContent === atual.resposta) {
        btn.classList.add("correct");
      }
    });
  }

  document.getElementById("score").textContent = score;
  updateGameTheme(); // **Importante:** Atualiza o tema ap√≥s mudar a pontua√ß√£o

  setTimeout(() => {
    indiceAtual++;
    if (indiceAtual >= glyphsEmbaralhados.length) {
      fimDeJogo();
    } else {
      carregarGlyph();
    }
  }, 2000);
}

function fimDeJogo() {
  document.getElementById("jogo").classList.add("hidden");
  document.getElementById("fim").classList.remove("hidden");
  document.getElementById("final-score").textContent = score;

  if (score >= glyphs.length / 2) {
    audioVitoria.play();
  } else {
    audioDerrota.play();
  }
  // No fim do jogo, o guia j√° deu o feedback de 'goodbye' ao voltar ao menu.
  // Ou, voc√™ pode adicionar um feedback espec√≠fico de "Fim de Jogo" aqui.
}

function reiniciar() {
  score = 0;
  indiceAtual = 0;
  glyphsEmbaralhados = shuffle([...glyphs]);
  document.getElementById("score").textContent = score;
  document.getElementById("fim").classList.add("hidden");
  document.getElementById("jogo").classList.remove("hidden");
  carregarGlyph();
  updateGameTheme(); // **Importante:** Reseta o tema para o inicial ao reiniciar o jogo
}

// Modo livre
document.getElementById("textoLivre").addEventListener("input", () => {
  const texto = document.getElementById("textoLivre").value;
  const mapa = {
    a: "ìÑø", b: "ìÉÄ", c: "ìé°", d: "ìÇß", e: "ìáã", f: "ìÜë",
    g: "ìéº", h: "ìéõ", i: "ìáã", j: "ìÜì", k: "ìé°", l: "ìÉ≠",
    m: "ìÖì", n: "ìàñ", o: "ìÖ±", p: "ìä™", q: "ìé§", r: "ìÇã",
    s: "ìã¥", t: "ìèè", u: "ìÖ±", v: "ìÜë", w: "ìÖ±", x: "ìêç",
    y: "ìáå", z: "ìäÉ", " ": " "
  };
  const convertido = texto.toLowerCase().split('').map(l => mapa[l] || '').join('');
  document.getElementById("saidaHieroglifo").textContent = convertido || "ìÄÄ";
});

// **Importante:** Garante que o tema inicial e a mensagem de boas-vindas do guia apare√ßam ao carregar a p√°gina
document.addEventListener('DOMContentLoaded', () => {
    updateGameTheme();
    showGuideFeedback('welcome'); // Mensagem de boas-vindas do guia no menu
});